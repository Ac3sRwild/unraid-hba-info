Menu="Utilities"
Title="LSI Monitor"
Icon="broadcom.png"
---
<?php

require_once "/usr/local/emhttp/plugins/dynamix/include/Helpers.php";
require_once "/usr/local/emhttp/plugins/dynamix/include/Wrappers.php";

$cfg = parse_plugin_cfg("lsi-mon");
$controllers = [];
exec('/usr/local/emhttp/plugins/lsi-mon/scripts/check_hba_info.sh', $output);

foreach ($output as $line) {
    // Expect tab-separated fields: controller_id  model  controller  serial  fw_ver  temp
    $fields = explode("\t", $line);
    if (count($fields) == 6) {
        $controllers[] = [
            'id' => $fields[0],
            'model' => $fields[1],
            'controller' => $fields[2],
            'serial' => $fields[3],
            'firmware_version' => $fields[4],
            'temperature' => $fields[5],
        ];
    }
}
?>

<form method="POST" action="/update.php" target="progressFrame" markdown="1">
<input type="hidden" name="#file" value="lsi-mon/lsi-mon.cfg">

_(StorCLI Version)_:
: <select name="STORCLIVER" size="1" class="narrow">
    <option value="storcli" <?= ($cfg['STORCLIVER'] ?? "") == 'storcli' ? 'selected' : ''; ?>>storcli</option>
    <option value="storcli2" <?= ($cfg['STORCLIVER'] ?? "") == 'storcli2' ? 'selected' : ''; ?>>storcli2</option>
    <option value="storcli-3205" <?= ($cfg['STORCLIVER'] ?? "") == 'storcli-3205' ? 'selected' : ''; ?>>storcli-3205</option>
  </select>

> Select which version of the storcli binary to use.
> - 93xx-95xx use storcli
> - 96xx use storcli2

_(Warning HBA temperature threshold)_ (&deg;<?=_var($display,'unit','C')?>):
: <input type="number" min="0" max="300" name="TEMPWARN" class="narrow" value="<?= htmlspecialchars($cfg['TEMPWARN']); ?>">

> *Warning HBA temperature* sets the warning threshold for this host bus adapters temperature. Exceeding this threshold will result in a warning notification.

_(Critical HBA temperature threshold)_ (&deg;<?=_var($display,'unit','C')?>):
: <input type="number" min="0" max="300" name="TEMPALERT" class="narrow" value="<?= htmlspecialchars($cfg['TEMPALERT']); ?>">

> *Critical HBA temperature* sets the critical threshold for this host bus adapters temperature. Exceeding this threshold will result in an alert notification.

_(HBA Temperature Monitoring Interval)_ (ms):
: <input type="number" min="2000" name="TEMPMONINT" class="narrow" value="<?= htmlspecialchars($cfg['TEMPMONINT']); ?>">

> Time in milliseconds to check HBA temperature and issue notifications. 

&nbsp;
: <span class="buttons-spaced">
    <input type="submit" value="_(Apply)_">
    <input type="button" value="_(Done)_" onclick="done()">
  </span>

</form>

<?if (count($controllers)):?>
<?foreach ($controllers as $c):?>

<div class="title"><span class="left"><i class="title fa fa-plus-square"></i>_(Controller)_ <?= htmlspecialchars($c['id']) ?></span></div>

_(Model)_:
: <?= htmlspecialchars($c['model'] ?? 'N/A') ?>

_(Controller)_:
: <?= htmlspecialchars($c['controller'] ?? 'N/A') ?>

_(Serial Number)_:
: <?= htmlspecialchars($c['serial'] ?? 'N/A') ?>

_(Firmware Version)_:
: <?= htmlspecialchars($c['firmware_version'] ?? 'N/A') ?>

_(Temperature)_:
: <span style="color: green;"><?= htmlspecialchars($c['temperature'] ?? 'N/A') ?> &deg;C</span>

<?endforeach;?>
<?else:?>
<p>No controllers detected.</p>
<?endif;?>
